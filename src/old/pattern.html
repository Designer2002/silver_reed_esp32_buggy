<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üß∂ –ü–∞—Ç—Ç–µ—Ä–Ω –≤—è–∑–∞–Ω–∏—è | ESP32</title>
   <link rel="stylesheet" href="/style.css">
  </head>
  <body>
    <div class="container">
      <h1>üß∂ –ü–∞—Ç—Ç–µ—Ä–Ω –≤—è–∑–∞–Ω–∏—è</h1>

      <div class="card">
        <h2>–ü–∞—Ç—Ç–µ—Ä–Ω</h2>

        <div class="info-box">
          <p>üìù <strong>–ü—Ä–∞–≤–∏–ª–∞:</strong></p>
          <p>
            ‚Ä¢ <span style="color: #ff9a9e; font-weight: bold">#</span> =
            –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ–ª–µ–Ω–æ–∏–¥ (1)
          </p>
          <p>
            ‚Ä¢ <span style="color: #ddd; font-weight: bold">.</span> = –Ω–µ
            –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ–ª–µ–Ω–æ–∏–¥ (0)
          </p>
          <p>‚Ä¢ –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è –≤—ã–¥–µ–ª–µ–Ω–∞ —Ç–æ–ª—Å—Ç—ã–º –±–æ—Ä–¥—é—Ä–æ–º</p>
        </div>

        <!-- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –û–ë–ï–†–ù–ò div —Å id="pattern-grid" –≤ —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
        <div class="pattern-container">
          <div class="pattern-grid" id="pattern-grid"></div>
        </div>

        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="current-row">0</div>
            <div class="stat-label">–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–æ–∫–∞</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="current-column">0</div>
            <div class="stat-label">–¢–µ–∫—É—â–∏–π —Å—Ç–æ–ª–±–µ—Ü</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="total-rows">0</div>
            <div class="stat-label">–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="total-columns">0</div>
            <div class="stat-label">–í—Å–µ–≥–æ —Å—Ç–æ–ª–±—Ü–æ–≤</div>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-success" onclick="startKnitting()">
            ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—è–∑–∞–Ω–∏–µ
          </button>
          <button class="btn btn-warning" onclick="stopKnitting()">
            ‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—è–∑–∞–Ω–∏–µ
          </button>
        </div>
      </div>

      <div class="footer">
        <p>
          ESP32 Knitting Machine Controller v2.0 | IP:
          <span id="device-ip">-</span>
        </p>
        <p>üå∏ –°–æ–∑–¥–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é –¥–ª—è –≤—è–∑–∞–Ω–∏—è üå∏</p>
      </div>
    </div>

    


  <script>
    let currentRow = 0;
    let currentColumn = 0;
    let totalRows = 0;
    let totalColumns = 0;
    let isKnitting = false;
    let patternGrid;

    // –ó–∞–ø—É—Å–∫ –≤—è–∑–∞–Ω–∏—è
    function startKnitting() {
      fetch("/start_knitting", { method: "POST" })
        .then((response) => response.text())
        .then((data) => {
          if (data === "OK") {
            isKnitting = true;
            document.querySelector(".btn-success").textContent =
              "‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—è–∑–∞–Ω–∏–µ";
            document.querySelector(".btn-success").onclick = stopKnitting;
          }
        })
        .catch((error) => console.error("Error:", error));
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—è–∑–∞–Ω–∏—è
    function stopKnitting() {
      fetch("/stop_knitting", { method: "POST" })
        .then((response) => response.text())
        .then((data) => {
          if (data === "OK") {
            isKnitting = false;
            document.querySelector(".btn-success").textContent =
              "‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—è–∑–∞–Ω–∏–µ";
            document.querySelector(".btn-success").onclick = startKnitting;
          }
        })
        .catch((error) => console.error("Error:", error));
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    function updateStatus() {
      fetch("/knitting_status")
        .then((response) => response.json())
        .then((data) => {
          currentRow = data.currentRow;
          currentColumn = data.currentColumn;
          totalRows = data.totalRows;
          totalColumns = data.totalColumns;
          isKnitting = data.isKnitting;

          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
          const progress = (currentRow / totalRows) * 100;
          document.getElementById("progress-bar").style.width =
            `${Math.min(progress, 100)}%`;

          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
          document.getElementById("current-row").textContent = currentRow;
          document.getElementById("current-column").textContent = currentColumn;
          document.getElementById("total-rows").textContent = totalRows;
          document.getElementById("total-columns").textContent = totalColumns;

          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
          updatePattern();
        })
        .catch((error) => console.error("Error:", error));
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
    function updatePattern() {
      if (!patternGrid) return;

      const pattern_path = "/pat.txt"; // –ü—É—Ç—å –∫ –≤–∞—à–µ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É

      fetch(pattern_path)
        .then((response) => response.text())
        .then((pattern) => {
          const rows = pattern.split("\n");
          const cells = patternGrid.querySelectorAll(".pattern-cell");

          rows.forEach((row, rowIndex) => {
            row.split("").forEach((char, colIndex) => {
              const index = rowIndex * rows[0].length + colIndex;
              if (index < cells.length) {
                if (
                  char === "#" ||
                  char === "@" ||
                  char === "X" ||
                  char === "x"
                ) {
                  cells[index].classList.add("active");
                } else {
                  cells[index].classList.remove("active");
                }
              }
            });
          });

          // –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
          if (currentRow < rows.length && currentColumn < rows[0].length) {
            const currentIndex = currentRow * rows[0].length + currentColumn;
            if (currentIndex < cells.length) {
              cells.forEach((cell) => (cell.style.borderColor = "#ddd"));
              cells[currentIndex].style.borderColor = "#e77e6d";
              cells[currentIndex].style.borderWidth = "2px";
            }
          }
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = function () {
      // –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É –ø–∞—Ç—Ç–µ—Ä–Ω–∞
      const pattern_path = "/pat.txt"; // –ü—É—Ç—å –∫ –≤–∞—à–µ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É
      fetch(pattern_path)
        .then((response) => response.text())
        .then((pattern) => {
          const rows = pattern.split("\n");
          const totalCells = rows.length * rows[0].length;

          patternGrid = document.getElementById("pattern-grid");
          patternGrid.innerHTML = "";

          for (let i = 0; i < totalCells; i++) {
            const cell = document.createElement("div");
            cell.className = "pattern-cell";
            patternGrid.appendChild(cell);
          }

          updatePattern();

          // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
          setInterval(updateStatus, 1000);

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å
          updateStatus();
        });
    };
  </script>
    </body>
</html>
