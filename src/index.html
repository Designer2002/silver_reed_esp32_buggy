<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üå∏ –í—è–∑–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ ESP32 üå∏</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <div class="container">
      <h1>üå∏ –í—è–∑–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ Silver Reed + ESP32 üå∏</h1>

      <div class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('main')">
          ü¶æ –û—Å–Ω–æ–≤–Ω–æ–µ
        </div>
        <div class="nav-tab" onclick="switchTab('pattern')">üåÄ –ü–∞—Ç—Ç–µ—Ä–Ω</div>
        <div class="nav-tab" onclick="switchTab('logs')">‚öôÔ∏è –õ–æ–≥–∏</div>
      </div>

      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ -->
      <div id="main-tab" class="tab-content active">
        <div class="card">
          <h2>üìä –°—Ç–∞—Ç—É—Å –≤—è–∑–∞–Ω–∏—è</h2>

          <div class="signal-grid">
            <div class="signal">
              <div class="signal-name">CCP</div>
              <div class="signal-value" id="ccp-value">–ù–µ—Ç</div>
            </div>
            <div class="signal">
              <div class="signal-name">HOK</div>
              <div class="signal-value" id="hok-value">–ù–µ—Ç</div>
            </div>
            <div class="signal">
              <div class="signal-name">KSL</div>
              <div class="signal-value" id="ksl-value">–ù–µ—Ç</div>
            </div>
            <div class="signal">
              <div class="signal-name">ND1</div>
              <div class="signal-value" id="nd1-value">–ù–µ—Ç</div>
            </div>
            <div class="signal">
              <div class="signal-name">DOB</div>
              <div class="signal-value" id="dob-value">–ù–µ—Ç</div>
            </div>
          </div>

          <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
          </div>

          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="current-row">0</div>
              <div class="stat-label">–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–æ–∫–∞</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="current-column">0</div>
              <div class="stat-label">–¢–µ–∫—É—â–∏–π —Å—Ç–æ–ª–±–µ—Ü</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="total-rows">0</div>
              <div class="stat-label">–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="total-columns">0</div>
              <div class="stat-label">–í—Å–µ–≥–æ —Å—Ç–æ–ª–±—Ü–æ–≤</div>
            </div>
          </div>

          <div class="info-box">
            <p>üí° <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong></p>
            <p>
              1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –≤—Å–µ –ø–∏–Ω—ã —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ö–µ–º–µ: CCP, HOK, KSL, ND1, DOB
            </p>
            <p>2. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—è–∑–∞–Ω–∏–µ" –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞</p>
            <p>3. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Å–∏–≥–Ω–∞–ª–æ–≤</p>
          </div>

          <div class="btn-group">
            <button
              class="btn btn-success"
              id="control-btn"
              onclick="toggleKnitting()"
            >
              ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—è–∑–∞–Ω–∏–µ
            </button>
            <button
              class="btn btn-success"
              id="test-log-btn"
              onclick="testLog()"
            >
              ·∂†·∂∏·∂ú·µè·µß‚Çí·µ§! –û—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–±–∞–Ω—ã–π –ª–æ–≥
            </button>
          </div>
        </div>
      </div>

      <!-- –ü–∞—Ç—Ç–µ—Ä–Ω –≤–∫–ª–∞–¥–∫–∞ -->
      <div id="pattern-tab" class="tab-content">
        <div class="card">
          <h2>üß∂ –ü–∞—Ç—Ç–µ—Ä–Ω –≤—è–∑–∞–Ω–∏—è</h2>

          <div class="info-box">
            <p>üìù <strong>–ü—Ä–∞–≤–∏–ª–∞:</strong></p>
            <p>
              ‚Ä¢ <span style="color: #ff9a9e; font-weight: bold">#</span> =
              –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ–ª–µ–Ω–æ–∏–¥ (1)
            </p>
            <p>
              ‚Ä¢ <span style="color: #ddd; font-weight: bold">.</span> = –Ω–µ
              –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ–ª–µ–Ω–æ–∏–¥ (0)
            </p>
          </div>

          <div class="pattern-container">
            <div class="pattern-grid" id="pattern-grid"></div>
          </div>

          <div class="btn-group">
            <button class="btn btn-success" onclick="toggleKnitting()">
              ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—è–∑–∞–Ω–∏–µ
            </button>
          </div>
        </div>
      </div>

      <!-- –õ–æ–≥–∏ –≤–∫–ª–∞–¥–∫–∞ -->
              <!-- –õ–æ–≥–∏ –≤–∫–ª–∞–¥–∫–∞ -->
        <div id="logs-tab" class="tab-content">
            <div class="card">
                <h2>üìù –õ–æ–≥–∏ –≤—è–∑–∞–Ω–∏—è</h2>

                <div class="info-box">
                    <p>üîç <strong>–í–∞–∂–Ω–æ:</strong></p>
                    <p>‚Ä¢ –í—Å–µ —Å–æ–±—ã—Ç–∏—è –≤—è–∑–∞–Ω–∏—è –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
                    <p>‚Ä¢ –õ–æ–≥–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
                </div>

                <div class="card" style="background: #f8f9fa; margin-top: 20px; height: 300px; overflow-y: auto; border-radius: 10px;">
                    <div id="logs-container" class="log-container"></div>
                </div>

                <button class="btn btn-warning" style="width: 100%; margin-top: 20px;" onclick="clearLogs()">
                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
                </button>
            </div>
        </div>

      <div class="footer">
        <p>
          ESP32 Knitting Machine Controller v2.0 | IP:
          <span id="device-ip">-</span>
        </p>
        <p>üå∏ –°–æ–∑–¥–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é –¥–ª—è –≤—è–∑–∞–Ω–∏—è üå∏</p>
      </div>
    </div>

   <script>
    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
    let isKnitting = false;
    let currentRow = 0;
    let currentColumn = 0;
    let totalRows = 0;
    let totalColumns = 0;
    let patternGrid = null; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞

    // –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã
    let statusIntervalId = null;
    let signalIntervalId = null;
    let patternIntervalId = null; // –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —á–∞—Å—Ç–æ)
    let logsIntervalId = null; // –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤

    // --- –ö–û–ù–°–¢–ê–ù–¢–´ ---
    const MAX_LOGS_STORED = 100; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤ –≤ localStorage
    const LOGS_STORAGE_KEY = 'knitting_logs'; // –ö–ª—é—á –¥–ª—è localStorage

    // --- –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø ---
    function toggleKnitting() {
        if (isKnitting) {
            stopKnitting();
        } else {
            startKnitting();
        }
    }
    function testLog(){
      fetch('/test_log', { method: 'POST' })
            .then(response => response.text())
            .then(data => {
                if (data === 'OK') {
                    console.log("–°—Ä–∞–Ω—ã–π –ª–æ–≥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –±–ª—è—Ç—å!");
                } else {
                    console.error("–û—à–∏–±–∫–∞ –µ–±—É—á–∞—è!", data);
                }
            })
            .catch(error => console.error('Error:', error));
    }
    function startKnitting() {
        fetch('/start_knitting', { method: 'POST' })
            .then(response => response.text())
            .then(data => {
                if (data === 'OK') {
                    isKnitting = true; // <-- –î–û–ë–ê–í–õ–ï–ù–û
                    updateControlButton();
                    console.log("–í—è–∑–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ.");
                } else {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤—è–∑–∞–Ω–∏—è:", data);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function stopKnitting() {
        fetch('/stop_knitting', { method: 'POST' })
            .then(response => response.text())
            .then(data => {
                if (data === 'OK') {
                    isKnitting = false; // <-- –î–û–ë–ê–í–õ–ï–ù–û
                    updateControlButton();
                    console.log("–í—è–∑–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.");
                } else {
                    console.error("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—è–∑–∞–Ω–∏—è:", data);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function updateControlButton() {
        const btn = document.getElementById('control-btn');
        if (btn) {
            if (isKnitting) {
                btn.textContent = '‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—è–∑–∞–Ω–∏–µ';
                btn.onclick = stopKnitting;
            } else {
                btn.textContent = '‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—è–∑–∞–Ω–∏–µ';
                btn.onclick = startKnitting;
            }
        }
    }

    // --- –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –í–ö–õ–ê–î–û–ö ---
    function switchTab(tabName) {
        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ç–µ–∫—É—â–µ–π –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–æ–π
        const activeMain = document.getElementById('main-tab').classList.contains('active');
        const activePattern = document.getElementById('pattern-tab').classList.contains('active');
        const activeLogs = document.getElementById('logs-tab').classList.contains('active');

        if (activeMain) {
            // –û—Å–Ω–æ–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞: –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏ —Å–∏–≥–Ω–∞–ª—ã
            if (statusIntervalId) clearInterval(statusIntervalId);
            if (signalIntervalId) clearInterval(signalIntervalId);
            statusIntervalId = null;
            signalIntervalId = null;
        }
        if (activePattern) {
            // –ü–∞—Ç—Ç–µ—Ä–Ω –≤–∫–ª–∞–¥–∫–∞: –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
            if (patternIntervalId) clearInterval(patternIntervalId);
            patternIntervalId = null;
        }
        if (activeLogs) {
            // –õ–æ–≥–∏ –≤–∫–ª–∞–¥–∫–∞: –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤
            if (logsIntervalId) clearInterval(logsIntervalId);
            logsIntervalId = null;
        }

        // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
        document.querySelectorAll('.tab-content').forEach(el => {
            el.classList.remove('active');
        });
        // –°–Ω—è—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å —Ç–∞–±–æ–≤
        document.querySelectorAll('.nav-tab').forEach(el => {
            el.classList.remove('active');
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
        const targetTab = document.getElementById(`${tabName}-tab`);
        if (targetTab) {
            targetTab.classList.add('active');
            // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–∞–±
            document.querySelector(`.nav-tab[onclick="switchTab('${tabName}')"]`).classList.add('active');

            // –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–∏
            if (tabName === 'main') {
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏ —Å–∏–≥–Ω–∞–ª–æ–≤
                if (!statusIntervalId) statusIntervalId = setInterval(updateStatus, 1000);
                if (!signalIntervalId) signalIntervalId = setInterval(updateSignalStatus, 500);
            } else if (tabName === 'pattern') {
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —á–∞—Å—Ç–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑ –≤ 2 —Å–µ–∫)
                // –ï—Å–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–µ–¥–∫–æ, –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å updatePattern() –æ–¥–∏–Ω —Ä–∞–∑
                updatePattern(); // –û–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
                // if (!patternIntervalId) patternIntervalId = setInterval(updatePattern, 2000);
            } else if (tabName === 'logs') {
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –ü–†–ò –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ò –ù–ê –í–ö–õ–ê–î–ö–£
                if (!logsIntervalId) {
                    console.log("Starting logs update interval for 'logs' tab.");
                    logsIntervalId = setInterval(fetchAndDisplayLogs, 2000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
                }
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏ —Å—Ä–∞–∑—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
                fetchAndDisplayLogs();
            }
        }
    }


    // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê ---
    function updateStatus() {
        fetch('/knitting_status')
            .then(response => response.json())
            .then(data => {
                currentRow = data.currentRow;
                currentColumn = data.currentColumn;
                totalRows = data.totalRows;
                totalColumns = data.totalColumns;
                isKnitting = data.isKnitting; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                const progress = totalRows > 0 ? (currentRow / totalRows) * 100 : 0;
                document.getElementById('progress-bar').style.width = `${Math.min(progress, 100)}%`;

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                document.getElementById('current-row').textContent = currentRow;
                document.getElementById('current-column').textContent = currentColumn;
                document.getElementById('total-rows').textContent = totalRows;
                document.getElementById('total-columns').textContent = totalColumns;

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–µ —á–µ—Ä–µ–∑ UI
                updateControlButton();
            })
            .catch(error => console.error('Error fetching status:', error));
    }

    // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø –°–ò–ì–ù–ê–õ–û–í ---
    function updateSignalStatus() {
         fetch('/signal_status')
            .then(response => response.json())
            .then(data => {
                document.getElementById('ccp-value').textContent = data.ccp;
                document.getElementById('hok-value').textContent = data.hok;
                document.getElementById('ksl-value').textContent = data.ksl;
                document.getElementById('nd1-value').textContent = data.nd1;
                document.getElementById('dob-value').textContent = data.dob;
            })
            .catch(error => console.error('Error fetching signal status:', error));
    }

    // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–ê–¢–¢–ï–†–ù–ê ---
    function updatePattern() {
        if (!patternGrid) {
             patternGrid = document.getElementById('pattern-grid');
             if (!patternGrid) {
                 console.error("Pattern grid element not found!");
                 return;
             }
             // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∫–∏ (–æ–¥–∏–Ω —Ä–∞–∑)
             // –£–±–∏—Ä–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∏–∑ onload, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–ª–∞—Å—å
             // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç—É—é —Å–µ—Ç–∫—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
             // –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –¥–æ–∂–¥–∞—Ç—å—Å—è –ø–µ—Ä–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –∫–∞–∫ —Ç–µ–∫—Å—Ç–∞
        fetch('/pat.txt') // –ò–ª–∏ –¥—Ä—É–≥–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç, –µ—Å–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω –º–µ–Ω—è–µ—Ç—Å—è
            .then(response => response.text())
            .then(text => {
                const lines = text.split('\n').filter(line => line.trim() !== '');
                const rows = lines;
                const cols = Math.max(...rows.map(r => r.length), 0);

                // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —è—á–µ–µ–∫
                const totalCells = rows.length * cols;
                const existingCells = patternGrid.querySelectorAll('.pattern-cell');
                if (existingCells.length !== totalCells) {
                     patternGrid.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—É—é —Å–µ—Ç–∫—É
                     for (let i = 0; i < totalCells; i++) {
                         const cell = document.createElement('div');
                         cell.className = 'pattern-cell';
                         patternGrid.appendChild(cell);
                     }
                }

                const cells = patternGrid.querySelectorAll('.pattern-cell');

                rows.forEach((row, rowIndex) => {
                    row.split('').forEach((char, colIndex) => {
                        const index = rowIndex * cols + colIndex;
                        if (index < cells.length) {
                            if (char === '#' || char === '@' || char === 'X' || char === 'x') {
                                cells[index].classList.add('active');
                            } else {
                                cells[index].classList.remove('active');
                            }
                        }
                    });
                });

                // –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ü–∞—Ç—Ç–µ—Ä–Ω")
                if (document.getElementById('pattern-tab').classList.contains('active')) {
                     cells.forEach(cell => {
                         cell.style.borderColor = '#ddd';
                         cell.style.borderWidth = '1px';
                     });
                     const currentIndex = currentRow * cols + currentColumn;
                     if (currentIndex < cells.length) {
                         cells[currentIndex].style.borderColor = '#e77e6d';
                         cells[currentIndex].style.borderWidth = '2px';
                     }
                }
            })
            .catch(error => console.error('Error fetching pattern:', error));
    }


    // --- –†–ê–ë–û–¢–ê –° –õ–û–ì–ê–ú–ò (localStorage) ---
    function loadLogsFromStorage() {
        try {
            const storedJson = localStorage.getItem(LOGS_STORAGE_KEY);
            if (storedJson) {
                const logs = JSON.parse(storedJson);
                // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —ç—Ç–æ –º–∞—Å—Å–∏–≤
                if (Array.isArray(logs)) {
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤
                    return logs.slice(-MAX_LOGS_STORED);
                }
            }
            return []; // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –æ—à–∏–±–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
        } catch (e) {
            console.error('Error parsing logs from localStorage:', e);
            return [];
        }
    }

    function saveLogsToStorage(logs) {
        try {
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
            const logsToSave = logs.slice(-MAX_LOGS_STORED);
            localStorage.setItem(LOGS_STORAGE_KEY, JSON.stringify(logsToSave));
        } catch (e) {
            console.error('Error saving logs to localStorage:', e);
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å, –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –ø–∞–Ω–∏–∫—É–µ–º
        }
    }

    function clearLogs() {
        console.log("Clearing logs from storage and display.");
        localStorage.removeItem(LOGS_STORAGE_KEY);
        // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ, –µ—Å–ª–∏ –æ–Ω–∞ "–õ–æ–≥–∏"
        const logsContainer = document.getElementById('logs-container');
        if (logsContainer && document.getElementById('logs-tab').classList.contains('active')) {
            logsContainer.innerHTML = '';
        }
    }

    // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –õ–û–ì–û–í (–æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞) ---
    async function fetchAndDisplayLogs() {
        // –ü—Ä–æ–≤–µ—Ä–∏–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ü–ï–†–ï–î fetch
        const logsContainer = document.getElementById('logs-container');
        if (!logsContainer) {
             console.error("CRITICAL ERROR: Logs container element '#logs-container' not found in DOM!");
             console.log("Available elements with 'logs' in ID:", Array.from(document.querySelectorAll('[id*="logs"]')).map(el => el.id));
             // –û—Å—Ç–∞–Ω–æ–≤–∏–º –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å—á–µ–∑
             if (logsIntervalId) {
                 clearInterval(logsIntervalId);
                 logsIntervalId = null;
                 console.log("Logs update interval stopped due to missing container.");
             }
             return;
        }

        console.log("Fetching logs from /logs..."); // –û—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

        try {
            const response = await fetch('/logs'); // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ª–æ–≥–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const newLogsArray = await response.json(); // –ü–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ –Ω–æ–≤—ã—Ö –ª–æ–≥–æ–≤ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
            console.log("Received new logs from server:", newLogsArray); // –û—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ª–æ–≥–∏ –∏–∑ localStorage
            let currentLogs = loadLogsFromStorage();
            console.log("Loaded logs from storage:", currentLogs);

            // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ –ª–æ–≥–∏
            const combinedLogs = [...currentLogs, ...newLogsArray];

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤
            const finalLogs = combinedLogs.slice(-MAX_LOGS_STORED);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤ localStorage
            saveLogsToStorage(finalLogs);
            console.log("Saved updated logs to storage. Count:", finalLogs.length);

            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –í–°–ï —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ª–æ–≥–∏
            logsContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º

            finalLogs.forEach(entry => {
                const logEntryDiv = document.createElement('div');
                logEntryDiv.className = 'log-entry';

                const timeSpan = document.createElement('span');
                timeSpan.className = 'log-timestamp';
                timeSpan.textContent = entry.timestamp;
                logEntryDiv.appendChild(timeSpan);

                const levelSpan = document.createElement('span');
                levelSpan.className = `log-level log-level-${entry.level.toLowerCase()}`;
                levelSpan.textContent = `[${entry.level}] `;
                logEntryDiv.appendChild(levelSpan);

                const messageSpan = document.createElement('span');
                messageSpan.className = 'log-message';
                messageSpan.textContent = entry.message;
                logEntryDiv.appendChild(messageSpan);

                logsContainer.appendChild(logEntryDiv);
            });

            // –ü—Ä–æ–∫—Ä—É—Ç–∏–º –≤–Ω–∏–∑
            logsContainer.scrollTop = logsContainer.scrollHeight;

        } catch (error) {
            console.error('Error fetching or displaying logs:', error);
            // –ü–æ–ø—Ä–æ–±—É–µ–º –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ª–æ–≥–∏ –∏–∑ localStorage
            const savedLogs = loadLogsFromStorage();
            logsContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            if (savedLogs.length > 0) {
                savedLogs.forEach(entry => {
                    const logEntryDiv = document.createElement('div');
                    logEntryDiv.className = 'log-entry';
                    logEntryDiv.innerHTML = `<span class="log-timestamp">${entry.timestamp}</span> <span class="log-level log-level-${entry.level.toLowerCase()}">[${entry.level}]</span> <span class="log-message">${entry.message}</span>`;
                    logsContainer.appendChild(logEntryDiv);
                });
            } else {
                // –ï—Å–ª–∏ –¥–∞–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–µ—Ç, –ø–æ–∫–∞–∂–µ–º –æ—à–∏–±–∫—É fetch
                const errorDiv = document.createElement('div');
                errorDiv.className = 'log-entry';
                errorDiv.innerHTML = `<span class="log-level log-level-error">[FETCH_ERROR]</span> <span class="log-message">Failed to load logs: ${error.message}. No cached logs available.</span>`;
                logsContainer.appendChild(errorDiv);
            }
            logsContainer.scrollTop = logsContainer.scrollHeight; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –æ—à–∏–±–∫–µ
        }
    }


    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ---
    window.onload = function() {
        console.log("Interface loaded.");
        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ª–æ–≥–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        const logsContainer = document.getElementById('logs-container');
        if (logsContainer) {
            const savedLogs = loadLogsFromStorage();
            if (savedLogs.length > 0) {
                 console.log("Displaying", savedLogs.length, "cached logs from localStorage.");
                 // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ª–æ–≥–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
                 savedLogs.forEach(entry => {
                     const logEntryDiv = document.createElement('div');
                     logEntryDiv.className = 'log-entry';
                     logEntryDiv.innerHTML = `<span class="log-timestamp">${entry.timestamp}</span> <span class="log-level log-level-${entry.level.toLowerCase()}">[${entry.level}]</span> <span class="log-message">${entry.message}</span>`;
                     logsContainer.appendChild(logEntryDiv);
                 });
                 logsContainer.scrollTop = logsContainer.scrollHeight; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ª–æ–≥—É
            } else {
                 console.log("No cached logs found in localStorage.");
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–∫–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –Ω–æ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏)
        // patternGrid = document.getElementById('pattern-grid'); // –£–∂–µ –≤ updatePattern

        // –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–û—Å–Ω–æ–≤–Ω–æ–µ" (–æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        if (!statusIntervalId) statusIntervalId = setInterval(updateStatus, 1000);
        if (!signalIntervalId) signalIntervalId = setInterval(updateSignalStatus, 500);

        // –û–±–Ω–æ–≤–∏–º —Å—Ç–∞—Ç—É—Å –∏ —Å–∏–≥–Ω–∞–ª—ã —Å—Ä–∞–∑—É
        updateStatus();
        updateSignalStatus();
    };

    // --- –û–ß–ò–°–¢–ö–ê –ü–†–ò –í–´–•–û–î–ï ---
    window.onbeforeunload = function() {
        if (statusIntervalId) clearInterval(statusIntervalId);
        if (signalIntervalId) clearInterval(signalIntervalId);
        if (patternIntervalId) clearInterval(patternIntervalId);
        if (logsIntervalId) clearInterval(logsIntervalId);
    };
</script>
  </body>
</html>
